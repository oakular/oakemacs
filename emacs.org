#+TITLE: An Emacs configuration
#+AUTHOR: Callum Warrilow
* Frame
  #+NAME: frame
  #+BEGIN_SRC emacs-lisp
    (line-number-mode t)
    (column-number-mode t)
    (size-indication-mode t)
  #+END_SRC

  Enable yes and no answers from ~y~ and ~n~.
  #+BEGIN_SRC emacs-lisp
    (fset 'yes-or-no-p 'y-or-n-p)
  #+END_SRC
* Identity
  #+BEGIN_SRC emacs-lisp
    (setq user-full-name "Callum Warrilow"
	  user-mail-address "callum_warrilow@outlook.com")
  #+END_SRC
* Sane Defaults
  Customize settings will be stored in a separate file.
  #+BEGIN_SRC emacs-lisp noweb
    (setq custom-file (expand-file-name "custom.el" user-emacs-directory))
    (show-paren-mode 1)
    (setq-default indent-tabs-mode nil)
    (save-place-mode 1)
    (setq visible-bell t)

    (defun oak/reload-config () "Reloads the configuration."
           (interactive)
           (load-file (expand-file-name "init.el" user-emacs-directory)))

    (defun oak/open-config () "Open the configuration project in a dired buffer."
              (interactive)
              (dired user-emacs-directory))

    (defun oak/backup-init (dirname) "Sets a backup directory under user-emacs-directory"
           (let ((oak-backup-dir (concat user-emacs-directory dirname)))
             (unless (file-directory-p oak-backup-dir)
               (make-directory oak-backup-dir t))
             (setq backup-directory-alist
                   `(("." . ,oak-backup-dir)))))

    (oak/backup-init "backups")

    (defun oak/add-auto-mode (ext mode) "Appends to pairing parameter to the auto-mode alist"
           (add-to-list 'auto-mode-alist '( (concat "\\" ext "\\'") mode)))

  #+END_SRC
* Package Management Setup
  We set the load path ourselves, and disable ~package.el~ from
  fetching and updating automatically.
  #+BEGIN_SRC emacs-lisp
    (eval-and-compile
      (setq load-prefer-newer t
	    package-user-dir (expand-file-name "pkg" user-emacs-directory)
	    package--init-file-ensured t
	    package-enable-at-startup nil)

      (unless (file-directory-p package-user-dir)
	(make-directory package-user-dir t)))


    (eval-and-compile
      (setq load-path (append load-path
			      (directory-files package-user-dir t "^[^.]" t))))
  #+END_SRC

  Install [[https://github.com/jwiegley/use-package][use-package]]
  #+BEGIN_SRC emacs-lisp
    (eval-when-compile
      (require 'package)

      (unless (assoc-default "melpa" package-archives)
        (add-to-list 'package-archives '("melpa" . "http://melpa.org/packages/") t))
      (unless (assoc-default "org" package-archives)
        (add-to-list 'package-archives '("org" . "http://orgmode.org/elpa/") t))

      (package-initialize)
      (unless (package-installed-p 'use-package)
        (package-refresh-contents)
        (package-install 'use-package))

      (require 'use-package)
      (setq use-package-always-ensure t
            use-package-always-defer t
            use-package-verbose t))
  #+END_SRC
* Theme
#+BEGIN_SRC emacs-lisp
  (defun oak/setup-fonts () "Setup basic font configuration."
         (set-face-attribute 'default nil :height 90)
         (set-face-attribute 'default nil :width 'condensed)
         (set-face-attribute 'default nil :family "Cascadia Mono"))

  (use-package modus-themes
    :ensure t
    :demand
    :pin gnu
    :config
    (load-theme 'modus-operandi t))

  (defvar oak-dark-theme 'modus-vivendi)
  (defvar oak-light-theme 'modus-operandi)

  (defun oak/load-dark-theme ()
    (interactive)
    (load-theme oak-dark-theme t))

  (defun oak/load-light-theme ()
    (interactive)
    (load-theme oak-light-theme t))

  (oak/setup-fonts)
#+END_SRC
* Global Keys
#+begin_src emacs-lisp
  (defun oak/define-global-keymap (keymap) "Define a keymap of global scope."
         (let ((map global-map))
           (define-key map (kbd (car keymap)) (cdr keymap))))

  (defun oak/define-global-keymaps (keymaps) "Define a set of keymaps of global scope."
         (dolist (keymap keymaps) (oak/define-global-keymap keymap) nil))

  (defun oak/global-keymaps () "Enables all global keymaps."
         (let ((keymaps '(("C-x cr" . oak/reload-config)
                          ("C-x ctd" . oak/load-dark-theme)
                          ("C-x ctl" . oak/load-light-theme))))
           (oak/define-global-keymaps keymaps)))

  (oak/global-keymaps)
#+end_src
* Evil                                                              :ARCHIVE:
    Define Evil global keybindings and initialize the mode.
    #+BEGIN_SRC emacs-lisp
      (defun oak/evil-global-keys () "Defines global keybindings using Evil mode."
          (evil-set-leader 'normal (kbd "SPC"))
          (defconst keymaps '(("w" . save-buffer)
                              ("ff" . find-file)
                              ("bd" . kill-buffer)
                              ("bb" . switch-to-buffer)
                              ("." . dired)
                              ("oa" . org-agenda)
                              ("rc" . oak/reload-config)
                              ("dP" . oak/open-config)))

          (oak/define-leader-keymaps keymaps))

      (defun oak/define-leader-keymap (keymap) "Defines a leader keymap for the keymap pairing given."
             (evil-define-key 'normal 'global (kbd (concat "<leader>" (car keymap))) (cdr keymap)))

      (defun oak/define-leader-keymaps (keymaps) "Defines a set of leader keymaps for the keymap pairings given."
           (dolist (keymap keymaps) (oak/define-leader-keymap keymap) nil))

      ;; (use-package evil
      ;;     :ensure t
      ;;     :defer nil
      ;;     :init
      ;;     (setq evil-want-keybinding nil)
      ;;     ;; (evil-mode 1)
      ;;     :config
      ;;     (oak/evil-global-keys)
      ;;     (setq evil-search-wrap t evil-regexp-search t))

      ;; (use-package evil-collection :after (evil))
    #+END_SRC

    Some evil plugins
    #+BEGIN_SRC emacs-lisp
      (use-package evil-commentary
          :ensure t
          :after (evil)
          :init
          (evil-commentary-mode))
    #+END_SRC
* Dired
#+begin_src emacs-lisp
  (defun oak/dired-detailed () "Format dired with detailed listings."
         (setq dired-listing-switches "-lh"))

  (defun oak/dired-concise () "Format dired with concise listings."
         (setq dired-listing-switches "-l1"))

  (defun oak/dired-all () "Format dired with all listings."
         (setq dired-listing-switches "-lah"))

  (add-hook 'dired-mode-hook #'dired-hide-details-mode)
  (oak/dired-detailed)

#+end_src

Use the elisp =ls= implementation.
#+begin_src emacs-lisp
  (setq ls-lisp-use-insert-directory-program nil)
  (require 'ls-lisp)
#+end_src
* Version Control
#+BEGIN_SRC emacs-lisp
  (use-package magit
    :ensure t
    :commands (magit-status magit-blame magit-log-buffer-file magit-log-all)
    :init
    (oak/define-global-keymap '("C-x vcm" . magit-status)))

  (use-package vc
    :pin gnu
    :commands (vc-dir vc-log-outgoing vc-log-incoming vc-annotate))

#+END_SRC
* Project Management
#+begin_src emacs-lisp
  (defun oak/project () "Setup project.el"
         (setq project-vc-merge-submodules nil))

  (use-package project
    :demand
    :pin gnu
    :config
    (oak/project))
#+end_src
* Software Development
** Eglot
The backbone of support for software development
#+begin_src emacs-lisp
  (use-package eglot :pin gnu)
#+end_src
** Web Mode
#+begin_src emacs-lisp
  (use-package web-mode
    :mode "\\.cshtml\\'"
    :config
    (add-hook 'web-mode-hook #'hl-line-mode))

  (add-to-list 'auto-mode-alist  "\\.css\\'" 'web-mode)
#+end_src
** Compilation
#+begin_src emacs-lisp
  (setq compilation-window-height 10)
  (setq compilation-scroll-output t)
#+end_src
** C#
  #+BEGIN_SRC emacs-lisp
    (use-package csharp-mode
      :ensure t
      :mode "\\.cs\\'"
      :config
      (add-hook 'csharp-mode-hook #'display-line-numbers-mode)
      (setq display-line-numbers 'relative)
      (add-hook 'csharp-mode-hook #'hl-line-mode)
      (let ((omnisharp-path (if WINDOWS
                                "~/bin/ominsharp/OmniSharp.exe"
                              "~/bin/omnisharp/run")))
        (add-to-list 'eglot-server-programs '(csharp-mode . ("~/bin/omnisharp/run" "-lsp")))))
  #+END_SRC

  Define functions for migrations.
  #+begin_src emacs-lisp
    (defun oak/dotnet-migration-add (migration-name project)
      "Add a migration to the given project"
      (let ((default-directory (vc-root-dir)))
        (async-shell-command (concat "dotnet ef migrations add" "-p"
                                     project
                                     migration-name))))

    (defun oak/dotnet-migration-remove (project)
      "Remove the latest migration from the given project"
      (async-shell-command (concat "dotnet ef migrations remove"
                                   "-p" project)))

    (defun oak/dotnet-update-database (project &optional context)
      "Update the database for the given project and context"
      (async-shell-command (concat "dotnet ef database update"
                                   "-p" project)))

    (defun oak/do-dotnet-migration-add () "Interactively add a migration."
           (interactive)
           (oak/dotnet-migration-add (read-string "Migration name: ")
                                     (read-directory-name "Project directory :")))

    (defun oak/do-dotnet-migration-remove () "Interactively remove the latest migration."
           (interactive)
           (oak/dotnet-migration-remove (read-directory-name "Project directory :")))

    (defun oak/do-dotnet-update-database ()
      "Interactively update the database"
      (interactive)
      (oak/dotnet-update-database (read-string "Project name: ")))
  #+end_src
** Csv
#+begin_src emacs-lisp
  (use-package csv-mode
    :pin gnu
    :config
    (add-to-list 'auto-mode-alist "\\.csv\\'" 'csv-mode))
#+end_src
** Javascript
#+begin_src emacs-lisp
  (use-package js2-mode
    :mode "\\.js\\'")
#+end_src
*** NodeJS
**** VueJS
 #+begin_src emacs-lisp
     (define-derived-mode vue-web-mode web-mode "Vue Web Mode")
     (add-to-list 'auto-mode-alist "\\.vue\\'" 'vue-web-mode)
     (setq vue-web-mode-script-padding 0)
     (add-hook 'vue-web-mode-hook 'eglot-ensure)
 #+end_src
* Ebooks
#+begin_src emacs-lisp
  (use-package nov
    :config
    (defun set-nov-font ()
      (face-remap-add-relative 'variable-pitch
                               :family "Liberation Serif"
                               :height 1.5))
    (setq nov-text-width 80)
    (add-to-list 'auto-mode-alist "\\.epub\\'" nov-mode))
#+end_src
* Org
Sane org defaults
  #+BEGIN_SRC emacs-lisp
    (use-package org
      :pin org)

    (setq org-directory "~/dropbox/org/")
    (setq org-archive-location (concat org-directory "archive/%s_archive::"))
    (setq org-startup-with-latex-preview t)
    (setq org-startup-indented t)
    (setq org-hide-emphasis-markers nil)
    (setq org-footnotes-auto-adjust t)
  #+END_SRC

Org agenda configuration.
  #+BEGIN_SRC emacs-lisp
    (setq org-agenda-files (list
                            (concat org-directory "journal.org")
                            (concat org-directory "work.org")))

    (setq org-agenda-span 1)
    (setq org-agenda-window-setup 'other-window)
    (setq org-agenda-show-all-dates t)
    (setq org-agenda-skip-scheduled-if-done t)
    (setq org-deadline-warning-days 3)
    (setq org-reverse-note-order t)
    (setq org-enforce-todo-dependencies t)
    (setq org-agenda-show-future-repeats "next")
    (setq org-agenda-use-time-grid nil)
    (setq org-agenda-clockreport-parameter-plist '(:link t :maxlevel 4))
    (setq org-agenda-follow-indirect t)

    (oak/define-global-keymap '("C-c oa" . org-agenda))
  #+END_SRC
* Email
#+begin_src emacs-lisp
  (use-package gnus
    :pin gnu
    :config
    (setq gnus-select-method
          '(nnimap "Email"
               (nnimap-address "outlook.office365.com")
               (nnimap-server-port 993)
               (nnimap-stream ssl)
               (nnimap-authinfo-file "~/.authinfo")
               (send-mail-function 'smtpmail-send-it)
               (smtpmail-smtp-server "smtp.office365.com")
               (smtpmail-smtp-type 'starttls)
               (smtpmail-smtp-service 587)))

    (setq message-send-mail-function 'smtpmail-send-it)
    (setq gnus-group-line-format "%g: %y%m\n"
          gnus-summary-line-format "%U%R%B %d - %f: %s\n"))

  (setq gnus-thread-sort-functions 'gnus-thread-sort-by-most-recent-date)
#+end_src
* Shell
#+begin_src emacs-lisp
  (defvar oak-shell "/bin/bash" "The default shell to be used.")

  (defun oak/term () "Opens an ansi-term buffer using the shell set by oak-shell"
         (interactive)
         (ansi-term oak-shell))

  (oak/define-global-keymap '("C-x tt" . oak/term))
#+end_src
** Direnv
#+begin_src emacs-lisp
  (use-package envrc
    :demand
    :config
    (envrc-global-mode))
#+end_src
** Eshell
#+begin_src emacs-lisp
(oak/define-global-keymap '("C-x te" . eshell))
#+end_src
** Commands
#+begin_src emacs-lisp
  (defun oak/restart-vpn () "Restart the openvpn instance."
         (interactive)
         (shell-command "doas sv restart openvpn"))

  (oak/define-global-keymap '("C-x !vr" . oak/restart-vpn))

  (defun oak/suspend () "Suspend the host machine."
         (interactive)
         (shell-command "loginctl suspend"))

  (oak/define-global-keymap '("C-x !s" . oak/suspend))
#+end_src
